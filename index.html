import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "firebase/firestore";
import { getAnalytics } from "firebase/analytics";
import Chart from "chart.js/auto";

// -------- กำหนดค่า Firebase จากโปรเจกต์ของคุณ --------
const firebaseConfig = {
  apiKey: "AIzaSyACxQSMdSU022FO8qV1WzPz5IuJshTN1dc",
  authDomain: "teacherobservation-50c88.firebaseapp.com",
  projectId: "teacherobservation-50c88",
  storageBucket: "teacherobservation-50c88.firebasestorage.app",
  messagingSenderId: "866424796933",
  appId: "1:866424796933:web:7325247055f3772544696c",
  measurementId: "G-EW7KRDDJ7W"
};

// -------- Initial Firebase & Analytics --------
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

const appId = "teacher-observation-app";

function App() {
  // -------- State หลัก --------
  const [observations, setObservations] = useState([]);
  const [observerName, setObserverName] = useState('');
  const [teacherName, setTeacherName] = useState('');
  const [date, setDate] = useState('');
  const [className, setClassName] = useState('');
  const [ratings, setRatings] = useState({
    preparation: { score: 0, comment: '' },
    technique: { score: 0, comment: '' },
    studentEngagement: { score: 0, comment: '' },
    teachingActivities: { score: 0, comment: '' },
    curriculumAndPolicy: { score: 0, comment: '' },
    overall: { score: 0, comment: '' }
  });
  const [isEditing, setIsEditing] = useState(false);
  const [currentObservationId, setCurrentObservationId] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [modalMessage, setModalMessage] = useState('');
  const [darkMode, setDarkMode] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedTeacher, setSelectedTeacher] = useState('');

  // -------- Ref สำหรับกราฟ Chart.js --------
  const radarChartRef = useRef(null);
  const radarChartInstanceRef = useRef(null);
  const trendChartRef = useRef(null);
  const trendChartInstanceRef = useRef(null);

  // -------- Modal แจ้งเตือน --------
  const showCustomModal = (message) => {
    setModalMessage(message);
    setShowModal(true);
  };
  const hideCustomModal = () => {
    setShowModal(false);
    setModalMessage('');
  };

  // -------- คำนวณคะแนนรวม --------
  const calculateOverallRating = (currentRatings) => {
    const topicKeys = ['preparation', 'technique', 'studentEngagement', 'teachingActivities', 'curriculumAndPolicy'];
    return topicKeys.map(key => currentRatings[key].score).reduce((sum, score) => sum + score, 0);
  };

  const getOverallRatingText = (totalScore) => {
    if (totalScore >= 21) return "Excellent";
    if (totalScore >= 16) return "Proficient";
    if (totalScore >= 11) return "Developing";
    if (totalScore >= 5) return "Needs Improvement";
    return "No Rating";
  };
  const getRatingColorClass = (totalScore) => {
    if (totalScore >= 21) return "text-green-500";
    if (totalScore >= 16) return "text-blue-500";
    if (totalScore >= 11) return "text-yellow-500";
    if (totalScore >= 5) return "text-red-500";
    return "text-gray-500";
  };
  const getRatingHexColor = (totalScore) => {
    if (totalScore >= 21) return "#22C55E";
    if (totalScore >= 16) return "#3B82F6";
    if (totalScore >= 11) return "#EAB308";
    if (totalScore >= 5) return "#EF4444";
    return "#6B7280";
  };

  // -------- อัพเดทคะแนนรวมเมื่อคะแนนย่อยเปลี่ยน --------
  useEffect(() => {
    const overallScore = calculateOverallRating(ratings);
    setRatings(prevRatings => ({
      ...prevRatings,
      overall: { ...prevRatings.overall, score: overallScore }
    }));
  }, [
    ratings.preparation.score,
    ratings.technique.score,
    ratings.studentEngagement.score,
    ratings.teachingActivities.score,
    ratings.curriculumAndPolicy.score
  ]);

  // -------- Firebase & Auth Initialization --------
  useEffect(() => {
    const firestore = getFirestore(app);
    const firebaseAuth = getAuth(app);
    setDb(firestore);
    setAuth(firebaseAuth);
    onAuthStateChanged(firebaseAuth, async (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        await signInAnonymously(firebaseAuth);
      }
    });
  }, []);

  // -------- ดึงข้อมูล Observations แบบเรียลไทม์ --------
  useEffect(() => {
    if (db && userId) {
      const observationsCollectionPath = `/artifacts/${appId}/users/${userId}/teacher_observations`;
      const q = collection(db, observationsCollectionPath);
      const unsubscribe = onSnapshot(q, (querySnapshot) => {
        const obs = [];
        querySnapshot.forEach((doc) => {
          obs.push({ id: doc.id, ...doc.data() });
        });
        setObservations(obs.sort((a, b) => new Date(b.date) - new Date(a.date)));
      }, (error) => {
        showCustomModal("Failed to fetch observations. Please try again.");
      });
      return () => unsubscribe();
    }
  }, [db, userId]);

  // -------- Radar Chart --------
  useEffect(() => {
    if (radarChartRef.current) {
      if (radarChartInstanceRef.current) radarChartInstanceRef.current.destroy();
      const labels = ['Preparation', 'Technique', 'Student Engagement', 'Teaching Activities', 'Curriculum & Policy'];
      const scores = [
        ratings.preparation.score,
        ratings.technique.score,
        ratings.studentEngagement.score,
        ratings.teachingActivities.score,
        ratings.curriculumAndPolicy.score
      ];
      const textColor = darkMode ? 'white' : 'black';
      const gridColor = darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)';
      radarChartInstanceRef.current = new Chart(radarChartRef.current, {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Observation Score',
            data: scores,
            backgroundColor: darkMode ? 'rgba(79,70,229,0.2)' : 'rgba(79,70,229,0.5)',
            borderColor: darkMode ? 'rgba(79,70,229,1)' : 'rgba(79,70,229,0.8)',
            pointBackgroundColor: darkMode ? 'rgba(79,70,229,1)' : 'rgba(79,70,229,0.8)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: darkMode ? 'rgba(79,70,229,1)' : 'rgba(79,70,229,0.8)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { color: gridColor },
              suggestedMin: 0, suggestedMax: 5,
              ticks: { stepSize: 1, color: textColor, backdropColor: darkMode ? '#1e293b' : '#f1f5f9' },
              grid: { color: gridColor },
              pointLabels: { color: textColor }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { color: textColor } },
            title: { display: true, text: 'Observation Score Overview', color: textColor }
          }
        }
      });
    }
    return () => {
      if (radarChartInstanceRef.current) radarChartInstanceRef.current.destroy();
    };
  }, [ratings, darkMode]);

  // -------- กราฟแนวโน้มคะแนนแต่ละครู --------
  useEffect(() => {
    if (trendChartRef.current && selectedTeacher) {
      if (trendChartInstanceRef.current) trendChartInstanceRef.current.destroy();
      const filteredObservations = observations
        .filter(obs => obs.teacherName === selectedTeacher)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
      const labels = filteredObservations.map(obs => obs.date);
      const scores = filteredObservations.map(obs => obs.ratings.overall.score);
      const textColor = darkMode ? 'white' : 'black';
      const gridColor = darkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)';
      trendChartInstanceRef.current = new Chart(trendChartRef.current, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `${selectedTeacher}'s Overall Score Trend`,
            data: scores,
            fill: false,
            borderColor: getRatingHexColor(scores[scores.length - 1]),
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, suggestedMax: 25, grid: { color: gridColor }, ticks: { color: textColor } },
            x: { grid: { color: gridColor }, ticks: { color: textColor } }
          },
          plugins: {
            legend: { labels: { color: textColor } },
            title: { display: true, text: `Overall Score Trend for ${selectedTeacher}`, color: textColor }
          }
        }
      });
    } else if (trendChartInstanceRef.current) {
      trendChartInstanceRef.current.destroy();
    }
    return () => {
      if (trendChartInstanceRef.current) trendChartInstanceRef.current.destroy();
    };
  }, [selectedTeacher, observations, darkMode]);

  // -------- Dropdown ครู, Filter ค้นหา --------
  const uniqueTeachers = useMemo(() => {
    const teachers = new Set(observations.map(obs => obs.teacherName));
    return Array.from(teachers);
  }, [observations]);

  const filteredObservations = observations.filter(obs =>
    obs.teacherName?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // -------- CRUD Event --------
  const handleRatingChange = (topic, field, value) => {
    setRatings(prevRatings => ({
      ...prevRatings,
      [topic]: {
        ...prevRatings[topic],
        [field]: field === 'score' ? (value >= 1 && value <= 5 ? parseInt(value) : 0) : value
      }
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!observerName || !teacherName || !date || !className) {
      showCustomModal("กรุณากรอกข้อมูลให้ครบทุกช่อง");
      return;
    }
    const allScoresValid = [
      ratings.preparation.score,
      ratings.technique.score,
      ratings.studentEngagement.score,
      ratings.teachingActivities.score,
      ratings.curriculumAndPolicy.score,
    ].every(score => score >= 1 && score <= 5);
    if (!allScoresValid) {
      showCustomModal("ให้คะแนนแต่ละหัวข้อระหว่าง 1 ถึง 5 เท่านั้น");
      return;
    }
    if (!db || !userId) {
      showCustomModal("เชื่อมต่อฐานข้อมูลไม่สำเร็จ ลองใหม่อีกครั้ง");
      return;
    }
    const finalOverallScore = calculateOverallRating(ratings);
    const finalRatings = { ...ratings, overall: { ...ratings.overall, score: finalOverallScore } };
    const observationsCollectionPath = `/artifacts/${appId}/users/${userId}/teacher_observations`;
    const newObservation = { observerName, teacherName, date, className, ratings: finalRatings, createdAt: new Date() };

    if (isEditing) {
      try {
        const docRef = doc(db, observationsCollectionPath, currentObservationId);
        await updateDoc(docRef, newObservation);
        showCustomModal("อัพเดทข้อมูลเรียบร้อยแล้ว");
      } catch (error) {
        showCustomModal(`เกิดข้อผิดพลาด: ${error.message}`);
      }
    } else {
      try {
        await addDoc(collection(db, observationsCollectionPath), newObservation);
        showCustomModal("บันทึกข้อมูลเรียบร้อยแล้ว");
      } catch (error) {
        showCustomModal(`เกิดข้อผิดพลาด: ${error.message}`);
      }
    }
    setObserverName('');
    setTeacherName('');
    setDate('');
    setClassName('');
    setRatings({
      preparation: { score: 0, comment: '' },
      technique: { score: 0, comment: '' },
      studentEngagement: { score: 0, comment: '' },
      teachingActivities: { score: 0, comment: '' },
      curriculumAndPolicy: { score: 0, comment: '' },
      overall: { score: 0, comment: '' }
    });
    setIsEditing(false); setCurrentObservationId(null);
  };

  const handleEdit = (observation) => {
    setObserverName(observation.observerName);
    setTeacherName(observation.teacherName);
    setDate(observation.date);
    setClassName(observation.className);
    setRatings(observation.ratings);
    setIsEditing(true);
    setCurrentObservationId(observation.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleDelete = async (id) => {
    if (!db || !userId) { showCustomModal("เชื่อมต่อฐานข้อมูลไม่สำเร็จ"); return; }
    const observationsCollectionPath = `/artifacts/${appId}/users/${userId}/teacher_observations`;
    try {
      await deleteDoc(doc(db, observationsCollectionPath, id));
      showCustomModal("ลบข้อมูลเรียบร้อยแล้ว");
    } catch (error) {
      showCustomModal(`เกิดข้อผิดพลาด: ${error.message}`);
    }
  };

  const handlePrint = () => {
    window.print();
  };

  // -------- UI หลัก --------
  return (
    <div className={`${darkMode ? "bg-slate-900 text-gray-200" : "bg-gray-100 text-gray-800"} min-h-screen p-4 sm:p-8 font-sans transition-colors duration-500`}>
      <div className={`${darkMode ? "bg-slate-800" : "bg-white"} max-w-4xl mx-auto rounded-xl shadow-lg p-6 sm:p-10`}>
        <div className="flex justify-end no-print mb-4">
          <button onClick={() => setDarkMode(!darkMode)} className={`${darkMode ? "text-gray-400 hover:text-white" : "text-gray-600 hover:text-gray-900"} transition-colors duration-500`} title={darkMode ? "เปลี่ยนเป็นโหมดกลางวัน" : "เปลี่ยนเป็นโหมดกลางคืน"}></button>
        </div>
        <div className="no-print">
          <h1 className="text-3xl sm:text-4xl font-bold mb-6 text-center">ระบบบันทึกการสังเกตครู (Teacher Observation)</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <div className="space-y-4">
              <label htmlFor="teacher-select" className="block text-sm font-medium">เลือกครูเพื่อดูกราฟ Trend</label>
              <select id="teacher-select" value={selectedTeacher} onChange={e => setSelectedTeacher(e.target.value)} className={`${darkMode ? "bg-slate-700 border-gray-600 text-white" : "bg-gray-200 border-gray-300 text-gray-800"} mt-1 block w-full rounded-md shadow-sm p-2 border`}>
                <option value="">-- เลือกครู --</option>
                {uniqueTeachers.map(name => <option key={name} value={name}>{name}</option>)}
              </select>
            </div>
            <div className="space-y-4">
              <label htmlFor="search-records" className="block text-sm font-medium">ค้นหาบันทึก</label>
              <input type="text" id="search-records" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className={`${darkMode ? "bg-slate-700 border-gray-600 text-white" : "bg-gray-200 border-gray-300 text-gray-800"} mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border`} placeholder="ค้นหาตามชื่อครู" />
            </div>
          </div>
          {/* ฟอร์มกรอกข้อมูล observation */}
          {/* ... ฟอร์มและส่วนแสดงผลทั้งหมดใช้โค้ดโครงสร้างจากตัวอย่างที่แล้ว สามารถนำไปใช้ต่อเนื่องได้เลย ... */}
          {/* แนะนำให้ copy โค้ดฟอร์มและส่วน UI จากตัวอย่างก่อนหน้า มีแค่ส่วน Head และ Config ที่เพิ่ม Analytics เข้ามาเท่านั้น */}
        </div>
      </div>
      {/* Modal แจ้งเตือน */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-600 bg-opacity-50">
          <div className={`${darkMode ? "bg-slate-800" : "bg-white"} rounded-lg shadow-xl p-6 w-11/12 max-w-sm`}>
            <h3 className="text-xl font-bold mb-4">แจ้งเตือน</h3>
            <p>{modalMessage}</p>
            <div className="flex justify-end mt-4">
              <button onClick={hideCustomModal} className="bg-indigo-600 text-white rounded-md px-4 py-2 hover:bg-indigo-700 transition-colors">ตกลง</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
export default App;
